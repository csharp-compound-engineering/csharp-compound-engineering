---
title: Architecture
---

# Architecture Documentation

This document provides a comprehensive overview of the CSharp Compound Docs plugin architecture, including system design, component interactions, and key design decisions.

## High-Level Overview

CSharp Compound Docs is a Claude Code plugin that implements the "compound-engineering" paradigm for C#/.NET projects. It enables developers to capture and retrieve institutional knowledge through:

- **GraphRAG pipeline** combining graph traversal with vector search
- **AWS OpenSearch Serverless** for vector storage and semantic search
- **Amazon Neptune** for knowledge graph storage (documents, concepts, relationships)
- **Amazon Bedrock** for embeddings (Titan) and LLM synthesis (Claude)
- **Git-based synchronization** via LibGit2Sharp for repository monitoring

### Key Principles

1. **GraphRAG Over Simple RAG** - Knowledge graph enrichment produces higher-quality answers than flat vector search
2. **Cloud-Native AWS** - Fully managed AWS services (Neptune, OpenSearch Serverless, Bedrock) eliminate infrastructure management
3. **Concept-Driven Knowledge** - Documents are decomposed into concepts and relationships, enabling multi-hop reasoning
4. **Cross-Repository Links** - Concepts can be resolved across multiple repositories

## System Architecture

```
+------------------------------------------------------------------+
|                      Claude Code / Claude Desktop                  |
+------------------------------------------------------------------+
                                |
                     HTTP transport (port 3000)
                                |
                                v
+------------------------------------------------------------------+
|                          MCP Server                               |
|                    (.NET 9.0 ASP.NET Core)                        |
|                                                                    |
|  +--------------------+  +--------------------+                    |
|  |   MCP Tool (1)     |  |  GraphRAG Pipeline |                   |
|  |                    |  |                    |                    |
|  | - rag_query        |  | - Query embedding  |                   |
|  |                    |  | - Vector search    |                   |
|  +--------------------+  | - Graph traversal  |                   |
|                          | - LLM synthesis    |                   |
|                          +--------------------+                    |
+------------------------------------------------------------------+
           |                |                |
           |                |                |
           v                v                v
+----------------+  +--------------+  +----------------+
| OpenSearch     |  | Amazon       |  | Amazon         |
| Serverless     |  | Neptune      |  | Bedrock        |
|                |  |              |  |                |
| - KNN vector   |  | - Document   |  | - Titan Embed  |
|   search       |  |   nodes      |  |   v2 (1024d)   |
| - Metadata     |  | - Concept    |  | - Claude       |
|   filtering    |  |   nodes      |  |   Haiku/Sonnet |
|                |  | - RELATES_TO |  |   /Opus        |
+----------------+  | - LINKS_TO   |  +----------------+
                    +--------------+
```

## Component Diagram

```
                    +-------------------+
                    |   Claude Code     |
                    |   Plugin System   |
                    +--------+----------+
                             |
                  MCP Protocol (HTTP)
                             |
                             v
                    +-------------------+
                    |    MCP Server     |
                    | (.NET 9 Host)     |
                    +--------+----------+
                             |
                    +--------+---------+
                    |                  |
                    v                  v
          +-----------------+  +------------------+
          |  RagQueryTool   |  |  Worker Service  |
          |  (MCP endpoint) |  |  (background)    |
          +---------+-------+  +--------+---------+
                    |                   |
                    v                   v
          +-----------------+  +------------------+
          | GraphRag        |  |  GitSync         |
          | Pipeline        |  |  (LibGit2Sharp)  |
          +---------+-------+  +------------------+
                    |
         +----------+----------+
         |          |          |
         v          v          v
   +---------+ +--------+ +----------+
   | Vector  | | Graph  | | Bedrock  |
   | Store   | | Repo   | | Services |
   +---------+ +--------+ +----------+
   |OpenSearch| |Neptune | |Titan Emb |
   |Serverless| |openCyph| |Claude LLM|
   +---------+ +--------+ +----------+
```

## Data Flow

### Document Ingestion Flow

```
Git Repository
       |
       v (clone / pull via LibGit2Sharp)
+------------------+
|  GitSync Worker  |
| (detect changes) |
+--------+---------+
         |
         | 1. Parse markdown documents
         | 2. Extract frontmatter
         v
+------------------+
| Entity Extractor |
| (Bedrock Haiku)  |
+--------+---------+
         |
         | 3. Extract concepts
         | 4. Identify relationships
         v
+------------------+     +------------------+
| Bedrock Embeddings|     | Neptune Graph    |
| (Titan v2, 1024d)|     |                  |
+--------+---------+     | 5. Upsert nodes: |
         |               |   Document       |
         | 6. Index       |   Section        |
         |    chunks      |   Chunk          |
         v               |   Concept        |
+------------------+     | 6. Create edges: |
| OpenSearch       |     |   HAS_SECTION    |
| Serverless       |     |   HAS_CHUNK      |
| (KNN index)      |     |   MENTIONS       |
+------------------+     |   RELATES_TO     |
                         |   LINKS_TO       |
                         +------------------+
```

### Query (RAG) Flow

```
User Query: "How do we handle connection pool exhaustion?"
       |
       v
+------------------+
|  rag_query Tool  |
+--------+---------+
         |
         | 1. Embed query (Titan v2)
         v
+------------------+
| OpenSearch       |
| Serverless       |
+--------+---------+
         |
         | 2. KNN vector search
         |    (top-k chunks)
         v
+------------------+
| Neptune Graph    |
+--------+---------+
         |
         | 3. Multi-hop traversal
         |    - Related concepts
         |    - Linked documents
         |    - Cross-repo links
         v
+------------------+
| Bedrock LLM      |
| (Claude Sonnet)  |
+--------+---------+
         |
         | 4. Synthesize answer
         |    with source attribution
         v
+------------------+
| GraphRagResult   |
| - Answer         |
| - Sources[]      |
| - RelatedConcepts|
| - Confidence     |
+------------------+
```

## Technology Stack

### Core Components

| Component | Technology | Purpose |
|-----------|------------|---------|
| MCP Server | .NET 9 ASP.NET Core | Application hosting, DI, logging |
| MCP Protocol | ModelContextProtocol.AspNetCore | Claude Code integration (HTTP) |
| Vector Storage | AWS OpenSearch Serverless | Semantic search via KNN |
| Knowledge Graph | Amazon Neptune (openCypher) | Concept relationships, multi-hop traversal |
| Embeddings | Amazon Bedrock (Titan Embed v2) | 1024-dimension vector generation |
| LLM Synthesis | Amazon Bedrock (Claude) | RAG answer generation, entity extraction |
| Git Sync | LibGit2Sharp | Repository cloning, change detection |

### Supporting Libraries

| Library | Purpose |
|---------|---------|
| Markdig | Markdown parsing, YAML frontmatter |
| NJsonSchema | Schema validation |
| YamlDotNet | YAML configuration parsing |
| Polly | Resilience (retry, circuit breaker) for all AWS calls |
| Serilog | Structured logging (stderr for MCP compliance) |
| AWSSDK.Neptunedata | Neptune openCypher query client |

### AWS Services

| Service | Purpose |
|---------|---------|
| OpenSearch Serverless | Vector index with KNN search |
| Neptune | Graph database for knowledge graph |
| Bedrock | Embeddings (Titan) + LLM (Claude Haiku/Sonnet/Opus) |

## Design Decisions

### Decision 1: GraphRAG Over Simple Vector RAG

**Choice**: Combine knowledge graph traversal with vector search for retrieval

**Rationale**:
- Multi-hop reasoning discovers related concepts that flat search misses
- Document relationships (LINKS_TO, RELATES_TO) provide structural context
- Concept nodes enable cross-document and cross-repository knowledge connections

**Trade-offs**:
- Higher complexity than simple vector-only RAG
- Requires maintaining both a graph database and a vector store

### Decision 2: AWS Cloud-Native Services

**Choice**: Use fully managed AWS services (Neptune, OpenSearch Serverless, Bedrock)

**Rationale**:
- Zero infrastructure management for databases and AI models
- Automatic scaling and high availability
- Consistent AWS IAM for authentication and authorization
- No local GPU or model management required

**Trade-offs**:
- Requires AWS account and credentials
- Running costs scale with usage
- Network latency compared to local services

### Decision 3: Tiered LLM Model Selection

**Choice**: Use different Claude model tiers (Haiku, Sonnet, Opus) for different tasks

**Rationale**:
- Entity extraction uses Haiku (cheapest) since it's a simpler task
- RAG synthesis uses Sonnet (balanced cost/quality)
- Complex reasoning tasks can escalate to Opus

**Trade-offs**:
- Configuration complexity for model IDs
- Different latency characteristics per tier

### Decision 4: Git-Based Change Detection

**Choice**: Use LibGit2Sharp to clone repositories and detect changes via git diff

**Rationale**:
- Git is the natural source of truth for code repositories
- Diff-based detection is efficient (only process changed files)
- Supports monitoring multiple repositories with configurable polling
- Branch awareness built in

**Trade-offs**:
- Polling-based (configurable interval, default 5 minutes)
- Requires git credentials for private repositories

### Decision 5: HTTP Transport

**Choice**: MCP server uses HTTP transport via ASP.NET Core (port 3000)

**Rationale**:
- Full ASP.NET Core middleware pipeline (authentication, authorization, health checks)
- API key authentication via `X-API-Key` header or `Authorization: Bearer` scheme
- Supports multiple concurrent clients
- Compatible with Kubernetes / containerized deployments

**Trade-offs**:
- Requires network access and port management
- Must configure authentication for security (enabled by default)

## Security Architecture

### Network Security

```
+-------------------+
|   Claude Code     |
|   (trusted)       |
+--------+----------+
         |
         | HTTP (port 3000, API key auth)
         v
+-------------------+
|    MCP Server     |
| (ASP.NET Core)    |
+--------+----------+
         |
         | HTTPS + AWS IAM SigV4
         v
+-------------------+     +-------------------+     +-------------------+
| OpenSearch        |     |    Neptune        |     |    Bedrock        |
| Serverless        |     |                   |     |                   |
| (AWS managed)     |     | (AWS managed)     |     | (AWS managed)     |
+-------------------+     +-------------------+     +-------------------+
```

### Security Boundaries

| Boundary | Protection |
|----------|------------|
| MCP Transport | HTTP with API key authentication (X-API-Key or Bearer token) |
| AWS Services | IAM authentication, SigV4 request signing |
| Neptune | VPC-based access control |
| OpenSearch Serverless | AWS IAM policies, encryption at rest |
| Bedrock | Model access policies, no data retention |

### Data Security

| Data Type | Protection |
|-----------|------------|
| Documents | Git repository access controls |
| Embeddings | OpenSearch Serverless encryption at rest |
| Graph Data | Neptune encryption at rest and in transit |
| AWS Credentials | IAM roles, environment variables, AWS credential chain |
| API Keys | AuthConfig with key-based access |

## Scalability Considerations

### Current Architecture

| Metric | Notes |
|--------|-------|
| Vector search | OpenSearch Serverless auto-scales |
| Graph queries | Neptune scales with instance size |
| Embeddings | Bedrock is serverless, scales on demand |
| Repositories | Configurable list with independent polling |
| Concurrent sessions | Multiple (HTTP transport supports concurrent connections) |

### Cross-Repository Support

The system supports monitoring multiple repositories:

```json
{
  "Repositories": [
    { "Url": "https://github.com/org/repo-a.git", "Name": "repo-a", "Branch": "main" },
    { "Url": "https://github.com/org/repo-b.git", "Name": "repo-b", "Branch": "main" }
  ]
}
```

Concepts discovered in one repository can be linked to concepts in another via the `ICrossRepoEntityResolver`.

## Monitoring and Observability

### Logging

| Component | Destination | Format |
|-----------|-------------|--------|
| MCP Server | stderr | Structured JSON (Serilog) |
| Worker Service | stderr | Structured JSON (Serilog) |
| AWS Services | CloudWatch | AWS native logging |

### Resilience

All AWS service calls use Polly resilience policies:
- Retry with exponential backoff
- Circuit breaker for sustained failures
- Timeout policies

## Project Structure

```
src/
  CompoundDocs.McpServer/      # MCP server with rag_query tool (HTTP transport, port 3000)
  CompoundDocs.Worker/         # Background worker (GitSync + ingestion)
  CompoundDocs.Common/         # Shared configuration and models
  CompoundDocs.Vector/         # OpenSearch Serverless client
  CompoundDocs.Graph/          # Neptune graph repository (openCypher)
  CompoundDocs.Bedrock/        # Bedrock embedding + LLM services
  CompoundDocs.GraphRag/       # GraphRAG pipeline orchestration
  CompoundDocs.GitSync/        # Git repository sync (LibGit2Sharp)
```
