---
title: Architecture
---

# Architecture Documentation

This document provides a comprehensive overview of the CSharp Compound Docs plugin architecture, including system design and component interactions.

## High-Level Overview

CSharp Compound Docs is a Claude Code plugin that implements the "compound-engineering" paradigm for C#/.NET projects. It enables developers to capture and retrieve institutional knowledge through:

- **GraphRAG pipeline** combining graph traversal with vector search
- **AWS OpenSearch Serverless** for vector storage and semantic search
- **Amazon Neptune** for knowledge graph storage (documents, concepts, relationships)
- **Amazon Bedrock** for embeddings (Titan) and LLM synthesis (Claude)
- **Git-based synchronization** via LibGit2Sharp for repository monitoring

### Key Principles

1. **GraphRAG Over Simple RAG** - Knowledge graph enrichment produces higher-quality answers than flat vector search
2. **Cloud-Native AWS** - Fully managed AWS services (Neptune, OpenSearch Serverless, Bedrock) eliminate infrastructure management
3. **Concept-Driven Knowledge** - Documents are decomposed into concepts and relationships, enabling multi-hop reasoning
4. **Cross-Repository Links** - Concepts can be resolved across multiple repositories

## System Architecture

```
+------------------------------------------------------------------+
|                      Claude Code / Claude Desktop                  |
+------------------------------------------------------------------+
                                |
                     HTTP transport (port 8080)
                                |
                                v
+------------------------------------------------------------------+
|                          MCP Server                               |
|                    (.NET 9.0 ASP.NET Core)                        |
|                                                                    |
|  +--------------------+  +--------------------+                    |
|  |   MCP Tool (1)     |  |  GraphRAG Pipeline |                   |
|  |                    |  |                    |                    |
|  | - rag_query        |  | - Query embedding  |                   |
|  |                    |  | - Vector search    |                   |
|  +--------------------+  | - Graph traversal  |                   |
|                          | - LLM synthesis    |                   |
|                          +--------------------+                    |
+------------------------------------------------------------------+
           |                |                |
           |                |                |
           v                v                v
+----------------+  +--------------+  +----------------+
| OpenSearch     |  | Amazon       |  | Amazon         |
| Serverless     |  | Neptune      |  | Bedrock        |
|                |  |              |  |                |
| - KNN vector   |  | - Document   |  | - Titan Embed  |
|   search       |  |   nodes      |  |   v2 (1024d)   |
| - Metadata     |  | - Concept    |  | - Claude       |
|   filtering    |  |   nodes      |  |   Haiku/Sonnet |
|                |  | - RELATES_TO |  |   /Opus        |
+----------------+  | - LINKS_TO   |  +----------------+
                    +--------------+
```

## Component Diagram

```
                    +-------------------+
                    |   Claude Code     |
                    |   Plugin System   |
                    +--------+----------+
                             |
                  MCP Protocol (HTTP)
                             |
                             v
                    +-------------------+      +-------------------+
                    |    MCP Server     |      |    Worker         |
                    | (.NET 9 Host)     |      | (K8s CronJob)    |
                    +--------+----------+      +--------+----------+
                             |                          |
                             v                          v
                    +-----------------+        +------------------+
                    |  RagQueryTool   |        |  GitSyncRunner   |
                    |  (MCP endpoint) |        |  + Ingestion     |
                    +---------+-------+        +--------+---------+
                              |                         |
                    +---------+---------+      +--------+---------+
                    |         |         |      |        |         |
                    v         v         v      v        v         v
              +---------+ +--------+ +----------+ +----------+
              | Vector  | | Graph  | | Bedrock  | | GitSync  |
              | Store   | | Repo   | | Services | |(Lib2Sharp|
              +---------+ +--------+ +----------+ +----------+
              |OpenSearch| |Neptune | |Titan Emb |
              |Serverless| |openCyph| |Claude LLM|
              +---------+ +--------+ +----------+
```

## Data Flow

### Document Ingestion Flow

```
Git Repository
       |
       v (clone / pull via LibGit2Sharp)
+------------------+
|  GitSync Worker  |
| (detect changes) |
+--------+---------+
         |
         | 1. Parse markdown documents
         | 2. Extract frontmatter
         v
+------------------+
| Entity Extractor |
| (Bedrock Haiku)  |
+--------+---------+
         |
         | 3. Extract concepts
         | 4. Identify relationships
         v
+------------------+     +------------------+
| Bedrock Embeddings|     | Neptune Graph    |
| (Titan v2, 1024d)|     |                  |
+--------+---------+     | 5. Upsert nodes: |
         |               |   Document       |
         | 6. Index       |   Section        |
         |    chunks      |   Chunk          |
         v               |   Concept        |
+------------------+     | 6. Create edges: |
| OpenSearch       |     |   HAS_SECTION    |
| Serverless       |     |   HAS_CHUNK      |
| (KNN index)      |     |   MENTIONS       |
+------------------+     |   RELATES_TO     |
                         |   LINKS_TO       |
                         +------------------+
```

### Query (RAG) Flow

```
User Query: "How do we handle connection pool exhaustion?"
       |
       v
+------------------+
|  rag_query Tool  |
+--------+---------+
         |
         | 1. Embed query (Titan v2)
         v
+------------------+
| OpenSearch       |
| Serverless       |
+--------+---------+
         |
         | 2. KNN vector search
         |    (top-k chunks)
         v
+------------------+
| Neptune Graph    |
+--------+---------+
         |
         | 3. Multi-hop traversal
         |    - Related concepts
         |    - Linked documents
         |    - Cross-repo links
         v
+------------------+
| Bedrock LLM      |
| (Claude Sonnet)  |
+--------+---------+
         |
         | 4. Synthesize answer
         |    with source attribution
         v
+------------------+
| GraphRagResult   |
| - Answer         |
| - Sources[]      |
| - RelatedConcepts|
| - Confidence     |
+------------------+
```

## Technology Stack

### Core Components

| Component | Technology | Purpose |
|-----------|------------|---------|
| MCP Server | .NET 9 ASP.NET Core | Application hosting, DI, logging |
| MCP Protocol | ModelContextProtocol.AspNetCore | Claude Code integration (HTTP) |
| Vector Storage | AWS OpenSearch Serverless | Semantic search via KNN |
| Knowledge Graph | Amazon Neptune (openCypher) | Concept relationships, multi-hop traversal |
| Embeddings | Amazon Bedrock (Titan Embed v2) | 1024-dimension vector generation |
| LLM Synthesis | Amazon Bedrock (Claude) | RAG answer generation, entity extraction |
| Git Sync | LibGit2Sharp | Repository cloning, change detection |

### Supporting Libraries

| Library | Purpose |
|---------|---------|
| Markdig | Markdown parsing, YAML frontmatter |
| NJsonSchema | Schema validation |
| YamlDotNet | YAML configuration parsing |
| Polly | Resilience (retry, circuit breaker) for all AWS calls |
| Microsoft.Extensions.Logging | Structured logging (Console provider) |
| AWSSDK.Neptunedata | Neptune openCypher query client |

### AWS Services

| Service | Purpose |
|---------|---------|
| OpenSearch Serverless | Vector index with KNN search |
| Neptune | Graph database for knowledge graph |
| Bedrock | Embeddings (Titan) + LLM (Claude Haiku/Sonnet/Opus) |

## Security Architecture

### Network Security

```
+-------------------+
|   Claude Code     |
|   (trusted)       |
+--------+----------+
         |
         | HTTP (port 8080, API key auth)
         v
+-------------------+
|    MCP Server     |
| (ASP.NET Core)    |
+--------+----------+
         |
         | HTTPS + AWS IAM SigV4
         v
+-------------------+     +-------------------+     +-------------------+
| OpenSearch        |     |    Neptune        |     |    Bedrock        |
| Serverless        |     |                   |     |                   |
| (AWS managed)     |     | (AWS managed)     |     | (AWS managed)     |
+-------------------+     +-------------------+     +-------------------+
```

### Security Boundaries

| Boundary | Protection |
|----------|------------|
| MCP Transport | HTTP with API key authentication (X-API-Key or Bearer token) |
| AWS Services | IAM authentication, SigV4 request signing |
| Neptune | VPC-based access control |
| OpenSearch Serverless | AWS IAM policies, encryption at rest |
| Bedrock | Model access policies, no data retention |

### Data Security

| Data Type | Protection |
|-----------|------------|
| Documents | Git repository access controls |
| Embeddings | OpenSearch Serverless encryption at rest |
| Graph Data | Neptune encryption at rest and in transit |
| AWS Credentials | IAM roles, environment variables, AWS credential chain |
| API Keys | AuthConfig with key-based access |

## Project Structure

```
src/
  CompoundDocs.McpServer/      # MCP server with rag_query tool (HTTP transport, port 8080)
  CompoundDocs.Worker/         # Background worker (GitSync + ingestion)
  CompoundDocs.Common/         # Shared configuration and models
  CompoundDocs.Vector/         # OpenSearch Serverless client
  CompoundDocs.Graph/          # Neptune graph repository (openCypher)
  CompoundDocs.Bedrock/        # Bedrock embedding + LLM services
  CompoundDocs.GraphRag/       # GraphRAG pipeline orchestration
  CompoundDocs.GitSync/        # Git repository sync (LibGit2Sharp)
```
