---
title: Troubleshooting
---

# Troubleshooting Guide

This guide covers common issues and their solutions when working with the CSharp Compound Docs MCP server.

## Quick Diagnostics

Run these checks to quickly identify common issues:

### Check AWS Connectivity

```bash
# Verify AWS credentials
aws sts get-caller-identity

# Check Neptune endpoint
curl -s https://<neptune-endpoint>:8182/status

# Check Bedrock model access
aws bedrock list-foundation-models --region us-east-1 \
  --query "modelSummaries[?modelId=='amazon.titan-embed-text-v2:0'].modelId"

# Check OpenSearch Serverless collection
aws opensearchserverless batch-get-collection \
  --names compound-docs --query "collectionDetails[0].status"
```

### Check MCP Server

```bash
# Start the server and check stderr for errors
dotnet run --project src/CompoundDocs.McpServer 2>&1

# Verify .NET version
dotnet --version
# Should be 9.0 or higher
```

## AWS Credential Issues

### Credentials Not Found

**Symptoms**:
- "Unable to find credentials" errors
- "Access Denied" from AWS services

**Solutions**:

1. **Check credential configuration**
   ```bash
   aws sts get-caller-identity
   ```

2. **Use AWS SSO**
   ```bash
   aws sso login --profile your-profile
   ```

3. **Set environment variables**
   ```bash
   export AWS_ACCESS_KEY_ID=your-key
   export AWS_SECRET_ACCESS_KEY=your-secret
   export AWS_DEFAULT_REGION=us-east-1
   ```

4. **Check credential chain order**
   - Environment variables
   - AWS credentials file (`~/.aws/credentials`)
   - AWS SSO cache
   - IAM instance role (on EC2/ECS)

### Wrong Region

**Symptoms**:
- "Could not find resource" errors
- Services not found

**Solution**:
Ensure `Aws.Region` in configuration matches the region where your Neptune cluster, OpenSearch collection, and Bedrock models are deployed.

## Neptune Issues

### Connection Refused

**Symptoms**:
- "Connection refused" to Neptune endpoint
- Timeout connecting to Neptune

**Solutions**:

1. **Verify endpoint**
   ```bash
   curl -s https://<endpoint>:8182/status
   ```

2. **Check network access**
   - Neptune runs inside a VPC
   - Your machine must be in the same VPC, connected via VPN, or using VPC peering
   - Security group must allow inbound on port 8182

3. **Verify IAM permissions**
   - Ensure your IAM principal has `neptune-db:*` permissions
   - For IAM authentication, check the Neptune cluster IAM policy

### Query Failures

**Symptoms**:
- openCypher query errors in logs
- "Malformed query" exceptions

**Solutions**:
- Check Neptune engine version supports openCypher
- Review the Serilog output for the exact query that failed
- Verify the graph schema has been initialized (nodes and relationships created)

## OpenSearch Serverless Issues

### Access Denied

**Symptoms**:
- HTTP 403 from OpenSearch Serverless
- "AccessDeniedException" in logs

**Solutions**:

1. **Check data access policy**
   - In the AWS Console, navigate to OpenSearch Serverless > Security > Data access policies
   - Ensure your IAM principal has permissions for the collection

2. **Check network policy**
   - Verify the network policy allows access from your network
   - For public access, ensure the network policy is configured for "Public"

3. **Verify collection status**
   ```bash
   aws opensearchserverless batch-get-collection --names compound-docs
   ```
   - Collection must be in ACTIVE state

### Vector Dimension Mismatch

**Symptoms**:
- KNN search returns errors about dimensions
- "Dimension mismatch" exceptions

**Cause**: The OpenSearch index was created with a different vector dimension than the embedding model produces.

**Solution**:
- Amazon Titan Embed Text v2 produces 1024-dimensional vectors
- The index must be configured for dimension 1024
- If the index was created with the wrong dimension, delete and recreate it

### Index Not Found

**Symptoms**:
- "index_not_found_exception" errors

**Solution**:
- Verify `OpenSearch.IndexName` matches the actual index name (default: `compound-docs`)
- The index is created automatically during first document ingestion
- Ensure the Worker has run at least once to create the index

## Bedrock Issues

### Model Access Denied

**Symptoms**:
- "AccessDeniedException" when calling Bedrock
- "You don't have access to the model" errors

**Solutions**:

1. **Enable model access**
   - In the AWS Console, navigate to Amazon Bedrock > Model access
   - Enable access for required models:
     - `amazon.titan-embed-text-v2:0`
     - `anthropic.claude-haiku-4-5-v1:0`
     - `anthropic.claude-sonnet-4-5-v1:0`

2. **Check IAM permissions**
   - Ensure `bedrock:InvokeModel` permission is granted
   - Check the resource ARN matches the model ID

3. **Check region availability**
   - Not all models are available in all regions
   - Verify the model IDs are valid for your configured region

### Embedding Generation Failures

**Symptoms**:
- `EMBEDDING_FAILED` error from `rag_query`
- Timeout during embedding generation

**Solutions**:
- Check Bedrock service health in the AWS Console
- Verify the embedding model ID is correct (`amazon.titan-embed-text-v2:0`)
- Check for throttling (Bedrock has per-account rate limits)
- Polly retry policies should handle transient failures automatically

### LLM Synthesis Failures

**Symptoms**:
- `RAG_SYNTHESIS_FAILED` error from `rag_query`
- Timeout during answer generation

**Solutions**:
- Check Bedrock service availability
- Verify the Claude model ID is correct
- For long queries or large context, the LLM call may exceed token limits
- Reduce `MaxChunksPerQuery` if context is too large

## MCP Server Issues

### Server Not Starting

**Symptoms**:
- MCP server process exits immediately
- No response from Claude Code

**Diagnostic Steps**:

1. **Run server manually to see errors**
   ```bash
   dotnet run --project src/CompoundDocs.McpServer 2>&1
   ```

2. **Check for missing dependencies**
   ```bash
   dotnet restore
   ```

3. **Verify .NET version**
   ```bash
   dotnet --version
   # Should be 9.0 or higher
   ```

### Tool Not Found

**Symptoms**:
- `rag_query` tool not appearing in Claude Code

**Solutions**:

1. **Verify MCP configuration**
   - Check the path to `CompoundDocs.McpServer.csproj` is correct
   - Ensure `command` is set to `dotnet`

2. **Restart Claude Code**
   - Close and reopen Claude Code/Desktop

3. **Check server startup logs**
   - Look for tool registration messages in stderr

## GraphRAG Pipeline Issues

### No Results Returned

**Symptoms**:
- `rag_query` returns empty sources
- Low confidence scores

**Solutions**:

1. **Verify documents are ingested**
   - Check Worker logs for successful ingestion
   - Verify documents exist in OpenSearch and Neptune

2. **Lower relevance threshold**
   - Set `GraphRag.MinRelevanceScore` to 0.5 or lower for testing

3. **Check query quality**
   - Ensure the query is specific enough to match indexed content
   - Try broader or more specific queries

### Poor Answer Quality

**Symptoms**:
- Answers are vague or off-topic
- Sources don't seem relevant

**Solutions**:

1. **Increase context**
   - Set `GraphRag.MaxChunksPerQuery` higher (e.g., 15-20)
   - Set `GraphRag.MaxTraversalSteps` higher for more concept discovery

2. **Check document quality**
   - Ensure source documents have meaningful content
   - Verify frontmatter is correct

3. **Enable cross-repo links**
   - Set `GraphRag.UseCrossRepoLinks` to `true` if monitoring multiple repos

## Git Sync Issues

### Repository Clone Failures

**Symptoms**:
- Worker fails to clone repositories
- Authentication errors from LibGit2Sharp

**Solutions**:

1. **Check repository URL**
   - Verify the URL is accessible
   - For private repos, ensure git credentials are available

2. **Check credentials**
   - SSH: Verify SSH key is configured
   - HTTPS: Ensure git credential helper is configured

3. **Check disk space**
   - Large repositories require sufficient disk space for cloning

### Changes Not Detected

**Symptoms**:
- New commits not triggering re-indexing
- Documents not updated after push

**Solutions**:

1. **Check polling interval**
   - Default is 5 minutes (`PollIntervalMinutes`)
   - Wait for the next poll cycle

2. **Check monitored paths**
   - If `MonitoredPaths` is set, only files under those paths trigger re-processing
   - Empty `MonitoredPaths` monitors all files

3. **Check Worker logs**
   - Look for git pull and diff detection messages

## Performance Issues

### Slow Query Responses

**Symptoms**:
- `rag_query` responses take more than a few seconds

**Solutions**:

1. **Reduce chunk count**
   - Lower `GraphRag.MaxChunksPerQuery` to reduce LLM context size

2. **Reduce traversal depth**
   - Lower `GraphRag.MaxTraversalSteps` for faster graph queries

3. **Check network latency**
   - AWS service latency depends on region proximity
   - Consider deploying closer to your AWS services

### High AWS Costs

**Solutions**:

1. **Reduce polling frequency**
   - Increase `PollIntervalMinutes` for less frequent repository checks

2. **Use Haiku for more tasks**
   - Haiku is the cheapest Claude model tier

3. **Optimize chunk size**
   - Larger chunks mean fewer embedding calls but less granular results

## Log Files and Diagnostics

### Log Output

All MCP server and Worker logs go to stderr using Serilog structured logging.

### Enabling Debug Logging

```json
{
  "Serilog": {
    "MinimumLevel": {
      "Default": "Debug",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    }
  }
}
```

Or via environment variable:
```bash
export SERILOG_LOGGING_LEVEL=Debug
```

### Log Levels

| Level | Purpose |
|-------|---------|
| Debug | Detailed execution flow, AWS request/response |
| Information | Normal operations (default) |
| Warning | Non-critical issues, degraded performance |
| Error | Operation failures |
| Fatal | System-stopping errors |

### Getting Help

If issues persist:

1. Check the [GitHub Issues](https://github.com/csharp-compound-engineering/csharp-compound-engineering/issues)
2. Search existing issues for similar problems
3. Open a new issue with:
   - Error messages (full text from stderr)
   - Steps to reproduce
   - Environment details (OS, .NET version, AWS region)
   - Relevant log output
