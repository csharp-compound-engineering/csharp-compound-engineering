# Default values for compound-docs Helm chart

image:
  repository: ghcr.io/csharp-compound-engineering/csharp-compound-engineering/mcp-server
  tag: ""  # Defaults to .Chart.AppVersion
  digest: ""  # Set by CI — overrides tag when non-empty
  pullPolicy: IfNotPresent

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

replicaCount: 1

# --- ArgoCD Sync Waves ---
syncWaves:
  provider: "0"
  providerConfig: "1"
  workspaces: "2"
  iamOpenSearchPolicy: "3"
  externalSecrets: "4"
  application: "5"

# --- Crossplane / OpenTofu ---
crossplane:
  enabled: true
  provider:
    package: xpkg.upbound.io/upbound/provider-opentofu:v1.0.3
  # DeploymentRuntimeConfig name — pins a deterministic SA name for pod identity matching
  runtimeConfigRef: provider-aws-pod-identity
  credentials:
    # Credential source for the ProviderConfig: "None" (pod identity) or "Secret" (static credentials)
    source: "None"
    # Only used when source: Secret
    secretName: aws-credentials
    secretKey: credentials

# --- External Secrets Operator ---
externalSecrets:
  enabled: false
  # Prefix for AWS Secrets Manager paths (e.g. "compound-docs" → "compound-docs/neptune")
  secretsManagerPrefix: ""
  # How often ESO polls Secrets Manager for changes
  refreshInterval: 1h
  # Explicit ESO reader IAM role ARN. If empty, a deterministic ARN is constructed
  # from aws.accountId: arn:aws:iam::<accountId>:role/<fullname>-eso-reader
  esoRoleArn: ""
  # Name for the ESO ServiceAccount. Defaults to <fullname>-eso
  esoServiceAccountName: ""

aws:
  region: us-east-1
  # AWS account ID — required when externalSecrets.enabled=true and esoRoleArn is empty
  accountId: ""

# --- VPC (pre-existing) ---
vpc:
  vpcId: ""
  privateSubnetIds: ""
  neptuneSecurityGroupId: ""
  opensearchSecurityGroupId: ""

# --- Neptune ---
# When crossplane.enabled: true, Neptune is provisioned via Crossplane workspace.
# When crossplane.enabled: false, supply endpoint/port directly.
neptune:
  enabled: true
  createServiceLinkedRole: true
  engineVersion: "1.2.0.1"
  instanceClass: "db.t4g.medium"
  connectionSecretName: compound-docs-neptune
  # Direct connection (used when crossplane.enabled: false)
  endpoint: ""
  port: "8182"

# --- OpenSearch Serverless ---
# When crossplane.enabled: true, OpenSearch is provisioned via Crossplane workspace.
# When crossplane.enabled: false, supply endpoint directly.
opensearch:
  enabled: true
  collectionName: compound-docs-vectors
  connectionSecretName: compound-docs-opensearch
  # Direct connection (used when crossplane.enabled: false)
  endpoint: ""

# --- IAM / Pod Identity ---
# When crossplane.enabled: true, IAM role is provisioned via Crossplane workspace.
# When crossplane.enabled: false, supply roleArn directly.
iam:
  enabled: true
  clusterName: ""
  connectionSecretName: compound-docs-iam
  # Direct connection (used when crossplane.enabled: false)
  roleArn: ""

# --- Bedrock ---
bedrock:
  embeddingModelId: "amazon.titan-embed-text-v2:0"
  sonnetModelId: "anthropic.claude-sonnet-4-5-v1:0"
  haikuModelId: "anthropic.claude-haiku-4-5-v1:0"
  opusModelId: "anthropic.claude-opus-4-5-v1:0"

# --- GraphRAG Pipeline ---
graphRag:
  maxTraversalSteps: 5
  maxChunksPerQuery: 10
  minRelevanceScore: 0.7
  useCrossRepoLinks: true

# --- Application ---
serviceAccount:
  create: true
  annotations: {}
  name: ""

service:
  type: ClusterIP
  port: 80
  targetPort: 8080

ingress:
  enabled: false
  # Ingress class name (e.g. "nginx", "alb")
  className: ""
  # Hostname for the Ingress rule — external-dns creates a DNS record for this value
  hostname: ""
  path: /
  pathType: Prefix
  # DNS TTL in seconds for the external-dns managed record
  ttl: ""
  # Additional annotations (e.g. cert-manager, ALB-specific)
  annotations: {}
  # TLS configuration
  # - secretName: compound-docs-tls
  #   hosts:
  #     - compound-docs.example.com
  tls: []
  # Additional host rules beyond the primary hostname
  extraHosts: []

resources:
  limits:
    cpu: "1"
    memory: 1Gi
  requests:
    cpu: 250m
    memory: 512Mi

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

podAnnotations: {}
podLabels: {}
nodeSelector: {}
tolerations: []
affinity: {}

auth:
  apiKeysSecretName: ""

logging:
  level: Information

# --- EFS (shared storage for git repos) ---
efs:
  enabled: false
  fileSystemId: ""
  accessPointId: ""
  storageCapacity: "50Gi"

# --- Git Sync ---
gitSync:
  intervalSeconds: 21600        # 6 hours
  cloneBaseDirectory: /data/repos
  sizeLimit: 2Gi                # emptyDir size limit
  # Map of repositories to sync. Key = repo name.
  # repositories:
  #   my-docs-repo:
  #     url: https://github.com/org/my-docs-repo.git
  #     branch: main
  #     monitoredPaths: ["docs/"]
  repositories: {}
  # Standalone CronJob for git sync (replaces background service)
  job:
    enabled: false
    schedule: "0 */6 * * *"
    image:
      repository: ghcr.io/csharp-compound-engineering/csharp-compound-engineering/gitsync-job
      tag: ""
      digest: ""  # Set by CI — overrides tag when non-empty
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: "1"
        memory: 1Gi

# =============================================================================
# Configuration Mode Examples
# =============================================================================
#
# Mode A: Crossplane + ESO (full infra provisioning with Secrets Manager)
# -----------------------------------------------------------------------
# crossplane:
#   enabled: true
# externalSecrets:
#   enabled: true
#   secretsManagerPrefix: compound-docs
# aws:
#   accountId: "123456789012"
# vpc:
#   vpcId: vpc-xxx
#   privateSubnetIds: "subnet-a,subnet-b"
#   neptuneSecurityGroupId: sg-xxx
#   opensearchSecurityGroupId: sg-yyy
# iam:
#   clusterName: my-eks-cluster
#
# Mode B: ESO only (pre-existing infra, user populates Secrets Manager)
# -----------------------------------------------------------------------
# crossplane:
#   enabled: false
# externalSecrets:
#   enabled: true
#   secretsManagerPrefix: compound-docs
#   esoRoleArn: arn:aws:iam::123456789012:role/my-eso-reader
#
# Mode C: Static fallback (no ESO, no Crossplane, direct values)
# -----------------------------------------------------------------------
# crossplane:
#   enabled: false
# externalSecrets:
#   enabled: false
# neptune:
#   endpoint: neptune.example.com
# opensearch:
#   endpoint: https://opensearch.example.com
# iam:
#   roleArn: arn:aws:iam::123456789012:role/my-app-role
